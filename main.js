var dense_matter_memory={},dense_matter_object={},elements_per_palette_object={},imesh_index_tracker={},imeshes_object={},animation_frametime=0,animation_direction=!0,animation_initiated=!1,animation_center_comm=!1,gif_frame_n=10,explosion_state_t=null,palette_state_t=null;const nDecimal=10,animation_time=2,animation_increment=.1;var color_animation=!0;$fx.features({Seed:seed,Triptych:triptych,Pigments:pigments,Palette:palette_name,Pattern:pattern,Dimension:dimension_type,Structure:noise_feature,Form:noise_form,Dissipation:noise_cull_rule,Attachment:attachment_type}),console.clear();var tectonica_logo="%c                                                                           \n%c     T E C T O N I C A  |  { p r o t o c e l l : l a b s }  |  2 0 2 3     \n%c                                                                           \n";console.log(tectonica_logo,`color: white; background: ${chosen_palette[0]}; font-weight: bold; font-family: "Courier New", monospace;`,`color: white; background: ${chosen_palette[1]}; font-weight: bold; font-family: "Courier New", monospace;`,`color: white; background: ${chosen_palette[2]}; font-weight: bold; font-family: "Courier New", monospace;`),console.log("%c    %c    %c    %c    %c    %c    %c    %c    %c    %c    ",`color: white; background: ${chosen_palette[0]};`,`color: white; background: ${chosen_palette[1]};`,`color: white; background: ${chosen_palette[2]};`,`color: white; background: ${chosen_palette[3]};`,`color: white; background: ${chosen_palette[4]};`,`color: white; background: ${chosen_palette[5]};`,`color: white; background: ${chosen_palette[6]};`,`color: white; background: ${chosen_palette[7]};`,`color: white; background: ${chosen_palette[8]};`,`color: white; background: ${chosen_palette[9]};`),console.log("%c TOKEN FEATURES ","color: white; background: #000000;","\n","Seed -> "+seed,"\n","Triptych -> "+triptych,"\n","Pigments -> "+pigments,"\n","Palette -> "+palette_name,"\n","Pattern -> "+pattern,"\n","Dimension -> "+dimension_type,"\n","Structure -> "+noise_feature,"\n","Form -> "+noise_form,"\n","Dissipation -> "+noise_cull_rule,"\n","Attachment -> "+attachment_type,"\n"),console.log("%c CONTROLS ","color: white; background: #000000;","\n","click      : explode/unexplode","\n","2x click","\n","   or      : new explosion center  ","\n","E + click   ","\n","P          : pause/unpause color cycle","\n","B          : white/black background","\n","S          : download loader","\n","G          : gif capture + explode","\n","1-5        : png capture 1-5x res","\n");var viewportHeight,viewportWidth,controller,composer_pass=0,viewport=document.getElementById("viewport"),margin_left=0,margin_top=0,background_toggle=!1,renderer=new THREE.WebGLRenderer({antialias:!1,alpha:!0,preserveDrawingBuffer:!0});renderer.toneMapping=THREE.LinearToneMapping,renderer.toneMappingExposure=10;const composer=new THREE.EffectComposer(renderer);let snap=!1,quality=0;var capturer=null;let recording=!1;function View(e){window.innerWidth/aspect_ratio>window.innerHeight?(viewportHeight=window.innerHeight,viewportWidth=aspect_ratio*window.innerHeight,margin_top=0,margin_left=(window.innerWidth-viewportWidth)/2):(viewportHeight=window.innerWidth/aspect_ratio,viewportWidth=window.innerWidth,margin_top=(window.innerHeight-viewportHeight)/2,margin_left=0),viewport.style.marginTop=margin_top+"px",viewport.style.marginLeft=margin_left+"px",cam_factor_mod=cam_factor*Math.min(viewportWidth/1e3,viewportHeight/1e3),renderer.setSize(viewportWidth,viewportHeight),renderer.shadowMap.enabled=!0,renderer.domElement.id="tectonicacanvas",viewport.appendChild(renderer.domElement);var t=new THREE.Scene,o=new THREE.OrthographicCamera(-viewportWidth/cam_factor_mod,viewportWidth/cam_factor_mod,viewportHeight/cam_factor_mod,-viewportHeight/cam_factor_mod,0,5e3);o.position.set(0,0,2e3),o.lookAt(new THREE.Vector3(0,0,0)),composer.setSize(window.innerWidth,window.innerHeight),t.background=new THREE.Color("#010102");var n=new THREE.DirectionalLight(16777215,1);n.position.set(2e3,2e3,750),n.castShadow=!0,n.shadow.camera.near=1e3,n.shadow.camera.far=3500,n.shadow.bias=-222e-6,n.shadow.camera.left=-1e3,n.shadow.camera.right=1e3,n.shadow.camera.top=1e3,n.shadow.camera.bottom=-1e3;var i=8192,r=!1;try{const e=window.location.search,t=new URLSearchParams(e),o=t.get("shadow");try{const e=t.get("explosion");null!=e&&(explosion_state_t=Math.abs(parseFloat(e)))}catch(e){}try{const e=t.get("palette");null!=e&&(palette_state_t=Math.abs(parseInt(e)))}catch(e){}try{const e=t.get("gif");null!=e&&(gif_frame_n=Math.abs(parseInt(e)))}catch(e){}null!=o&&(i=Math.abs(parseInt(o)),r=!0)}catch(e){}Number.isInteger(i)&r?(console.log("Using custom url parmater for shadow map size: "+i.toString()),n.shadow.mapSize.width=i,n.shadow.mapSize.height=i):Number.isInteger(i)&iOS()?(n.shadow.mapSize.width=Math.min(i,2048),n.shadow.mapSize.height=Math.min(i,2048)):Number.isInteger(i)&!iOS()?(n.shadow.mapSize.width=Math.max(i,4096),n.shadow.mapSize.height=Math.max(i/2,4096)):(n.shadow.mapSize.width=8192,n.shadow.mapSize.height=4096),t.add(n);const a=new THREE.AmbientLight(16777215,.015);t.add(a),this.winHeight=viewportHeight,this.winWidth=viewportWidth,this.scale=1,this.scene=t,this.camera=o,this.composer=composer,this.light=n,this.renderer=renderer,this.wire=null,this.lines=null,this.meshline_data=[],this.meshline_mesh=[],this.curves=[];const s=new THREE.RenderPass(this.scene,this.camera);this.composer.addPass(s);const c=new THREE.UnrealBloomPass;c.strength=.1,c.radius=0,c.threshold=.05,this.composer.addPass(c);const l=new THREE.OutputPass;this.composer.addPass(l),effectFXAA=new THREE.ShaderPass(THREE.FXAAShader),effectFXAA.uniforms.resolution.value.x=1/(window.innerWidth*window.devicePixelRatio),effectFXAA.uniforms.resolution.value.y=1/(window.innerHeight*window.devicePixelRatio),this.composer.addPass(effectFXAA)}function Controller(e){var t=new View(e);t.cam_distance=700,this.view=t,t.addDenseMatter(),t.addStarsRandom(1e3,15e3),"middle"==triptych&&(t.addStarDust(),t.addMoon()),t.preRender();var o=(new Date).getTime()-loading_start_time;if(o>min_loading_time){for(i=0;i<21;i++){let e=i;setTimeout((function(){document.querySelector("#loading").style.opacity=1-.05*e}),100*e)}setTimeout((function(){document.querySelector("#loading").style.display="none"}),2e3),t.render()}else{for(i=0;i<21;i++){let e=i;setTimeout((function(){document.querySelector("#loading").style.opacity=1-.05*e}),min_loading_time-o+100*e)}setTimeout((function(){document.querySelector("#loading").style.display="none"}),min_loading_time-o+2e3),t.render()}setTimeout((function(){$fx.preview()}),min_loading_time+3e3),window.addEventListener("resize",(function(){viewportAdjust(document.getElementById("viewport"),!1),fitCameraToViewport(t,viewportWidth,viewportHeight)}));const n=new THREE.Raycaster,r=new THREE.Vector2;function a(e){r.x=e.clientX/window.innerWidth*2-1,r.y=-e.clientY/window.innerHeight*2+1,n.setFromCamera(r,t.camera);const o=n.intersectObjects(t.scene.children,!0);explosion_power=gene_range(5,15),explosion_strength=2e5*explosion_power;for(let e=0;e<o.length;e++){o[e].point.z=0,View.prototype.DenseMatterCreateExplosionVectors(o[e].point);break}View.prototype.preRender()}function s(e){animation_initiated?animation_direction=!animation_direction:animation_initiated=!0,animation_center_comm&&(a(e),animation_center_comm=!1)}var c;window.addEventListener("mousedown",(function(e){c=window.setTimeout((function(){!function(e){a(e)}(e),s()}),2e3)})),window.addEventListener("mouseup",(function(e){c&&(window.clearTimeout(c),s(e))}))}function tectonica(){controller=new Controller("viewport")}function viewportAdjust(e,t=!0){t?(window.innerWidth/aspect_ratio>window.innerHeight?(viewportHeight=window.innerHeight,viewportWidth=aspect_ratio*window.innerHeight,margin_top=0,margin_left=(window.innerWidth-viewportWidth)/2):(viewportHeight=window.innerWidth/aspect_ratio,viewportWidth=window.innerWidth,margin_top=(window.innerHeight-viewportHeight)/2,margin_left=0),cam_factor_mod=cam_factor*Math.min(viewportWidth/1e3*quality,viewportHeight/1e3*quality)):(window.innerWidth/aspect_ratio>window.innerHeight?(viewportHeight=window.innerHeight,viewportWidth=aspect_ratio*window.innerHeight,margin_top=0,margin_left=(window.innerWidth-viewportWidth)/2):(viewportHeight=window.innerWidth/aspect_ratio,viewportWidth=window.innerWidth,margin_top=(window.innerHeight-viewportHeight)/2,margin_left=0),cam_factor_mod=cam_factor*Math.min(viewportWidth/1e3,viewportHeight/1e3)),e.style.marginTop=margin_top+"px",e.style.marginLeft=margin_left+"px"}function fitCameraToViewport(e,t,o,n=!0){e.renderer.setSize(t,o),e.composer.setSize(t,o),n&&(e.camera.left=-t/cam_factor_mod,e.camera.right=t/cam_factor_mod,e.camera.top=o/cam_factor_mod,e.camera.bottom=-o/cam_factor_mod),e.camera.updateProjectionMatrix()}function capturer_custom_save(){console.log("Saving"),setTimeout((()=>{capturer.save((function(e){const t=URL.createObjectURL(e),o=document.createElement("a");o.href=t,o.download=`tectonica_${palette_name}_anim_${parseInt(1e7*Math.random())}.gif`,o.click(),URL.revokeObjectURL(t)})),setTimeout((()=>{capturer=null}),250)}),0)}function check_drawing_buffer(e){var t=e*Math.max(viewportWidth,viewportHeight);if(t>5500){var o=5500*e/t;return console.log("Browser drawing buffer exceed. Reverting to the following quality multiplier: "+o.toFixed(2).toString()),o}return e}function doc_keyUp(e){49===e.keyCode||97===e.keyCode?(snap=!0,quality=1):50===e.keyCode||98===e.keyCode?(snap=!0,quality=check_drawing_buffer(2)):51===e.keyCode||99===e.keyCode?(snap=!0,quality=check_drawing_buffer(3)):52===e.keyCode||100===e.keyCode?(snap=!0,quality=check_drawing_buffer(4)):53===e.keyCode||101===e.keyCode?(snap=!0,quality=check_drawing_buffer(5)):71===e.keyCode?(recording=!recording,recording?(capturer=new CCapture({verbose:!1,display:!1,framerate:gif_frame_n,format:"gif",workersPath:"js/capture/src/"}),animation_frametime=0,animation_direction=!0,animation_initiated=!0,capturer.start(),setTimeout((()=>{null!=capturer&&(capturer.stop(),capturer_custom_save())}),5e3)):null!=capturer&&(capturer.stop(),capturer_custom_save())):66===e.keyCode?(background_toggle=!background_toggle)?(document.body.style.backgroundColor="white",console.log("Background: white")):(document.body.style.backgroundColor="black",console.log("Background: black")):69===e.keyCode?(console.log("pick point for explosion"),animation_center_comm=!0):80===e.keyCode&&(color_animation=!color_animation)}View.prototype.addDenseMatter=function(){const e=[["sol",1],["uni",1],["ver",1],["hor",1],["wid",1],["hei",1],["dep",1]],t=[[1.5,1],[1.75,1],[2,1],[3,1],[4,1]],o=[[.05,2],[.1,1],[.15,1],[.2,1]],n=[[.1,1],[.2,1],[.3,1],[.4,1],[.5,1]],i=[[.1,1],[.2,1],[.3,1],[.4,1],[.5,1]],r={voxel:["square 1x1",8,8,70,110,20],pin:["square beam",5,25,115,37,30],stick:["square beam",5,50,115,20,30],needle:["square beam",2.5,75,220,15,30],wire:["square beam",2.5,100,110,11,30]},a={"square beam":[.5,.5,1,4,1],"square 1x1":[.7,.7,1,4,1]};if("noisy"==pattern)var s="uni";if("graded"==pattern)s=gene()<.5?"ver":"hor";if("layered"==pattern)s=gene()<.5?"sol":"dep";if("stacked"==pattern)s="hei";if("composed"==pattern)s="sol";var c="composed"==pattern,l=gene_weighted_choice(t),d=gene_weighted_choice(t),p=[gene_weighted_choice(e),gene_weighted_choice(e),gene_weighted_choice(e),gene_weighted_choice(e)],h="voxel"==dimension_type||"needle"==dimension_type?.5:1;"wire"==dimension_type&&(h=.75);var m=r[dimension_type][0],_=r[dimension_type][1],g=r[dimension_type][2],w=r[dimension_type][3],u=r[dimension_type][4],f=r[dimension_type][5],v={tight:1,detached:10,loose:25,floating:50}[attachment_type],y="wire"==dimension_type?3:0;if("stick"==dimension_type)var E=12;else if("needle"==dimension_type||"wire"==dimension_type)E=-10;else E=0;"left"==triptych&&"voxel"==dimension_type?E-=5:"right"==triptych&&"voxel"==dimension_type?E+=5:"left"==triptych&&"pin"==dimension_type?E-=5:"right"==triptych&&"pin"==dimension_type?E+=5:"left"==triptych&&"stick"==dimension_type?E+=20:"right"==triptych&&"stick"==dimension_type?E-=20:"left"==triptych&&"needle"==dimension_type?E+=20:"right"==triptych&&"needle"==dimension_type?E-=20:"left"==triptych&&"wire"==dimension_type?E+=20:"right"==triptych&&"wire"==dimension_type&&(E-=20);var b,M,x,H,T,k=-w*(_+y)/2,R=E-u*(g+v)/2,C=-f*(_+y)/2,I=0,P=w*u*f,S=[gene_weighted_choice([["non",80],["vspa",5],["vdas",5],["vblo",5],["vsol",5]]),gene_weighted_choice([["non",85],["hdas",5],["hblo",5],["hsol",5]])],W=Math.floor(gene_range(2,20)),j=Math.floor(gene_range(2,20)),A=Math.floor(gene_range(2,20)),D=Math.floor(gene_range(2,20)),V=Math.floor(gene_range(5,15)),q=Math.floor(gene_range(1,V)),U=Math.floor(gene_range(50,150)),O=Math.floor(U/2),z=gene()<.5?1:-1,F=-z,L="expressive"==noise_form?[1,1]:[.1,.25],B=g/_;"cracks"==noise_feature?(b=gene_weighted_choice(o)*L[1],M=.01*L[0],x=.025):"bands"==noise_feature?(b=.01*L[0],M=gene_weighted_choice(n),x=.05*L[0]):"sheets"==noise_feature?(b=.01*L[0],M=.01*L[0],x=gene_weighted_choice(i)):(b=.01*L[0],M=.01*L[0],x="clean"==noise_cull_rule?.05:.01);var $=500*b/_,X=125*M/g;"voxel"==dimension_type&&(X=25*M/g),"right"==triptych?(H=$,T=X):"left"==triptych?(H=-$,T=-X):(H=0,T=0);var N=gene_range(-100,100)+H,G=gene_range(-100,100)+T,Y=gene_range(-100,100);for(Z in chosen_palette)elements_per_palette_object[chosen_palette[Z]]=0,imesh_index_tracker[chosen_palette[Z]]=0;for(var Z=0;Z<w;Z++)for(var Q=0;Q<u;Q++)for(var K=0;K<f;K++){var J=s,ee=0;Z>w/l&&Q>u/d&&1==c?(J=p[0],ee=0):Z<w/l&&Q>u/d&&1==c?(J=p[1],ee=0):Z>w/l&&Q<u/d&&1==c?(J=p[2],ee=0):1==c&&(J=p[3],ee=0);var te,oe=!1;S.includes("vspa")&&Math.floor(Z/W)%j==Z%A&&(J="wid",ee=0,oe=!0),S.includes("vdas")&&Math.floor(Z/D)%V==q&&(J="wid",ee=10*F,oe=!0),S.includes("vblo")&&Math.floor(Z/D)%V==q&&(J="hei",ee=10*F,oe=!0),S.includes("vsol")&&Math.floor(Z/D)%V==q&&(J="dep",ee=10*F,oe=!0),S.includes("hdas")&&Q%V==q&&(J="wid",ee=10*z,oe=!0),S.includes("hsol")&&Q%V==q&&(J="hei",ee=10*z,oe=!0),S.includes("hblo")&&Q%V==q&&Z%U>U/2&&Z%U<=O+U/2&&(J="hei",ee=10*z,oe=!0),te="sol"==J?[50,1,1,1,1,1,1,1,1,1]:"uni"==J?chosen_palette.length>4?[0,0,1,1,1,1,1,1,1,1]:[0,1,1,1,1,1,1,1,1,1]:"ver"==J?[Q,u-Q,1,1,1,1,1,1,1,1]:"hor"==J?[Z,w-Z,1,1,1,1,1,1,1,1]:[0,0,0,0,0,0,0,0,0,0];for(var ne=[],ie=0;ie<chosen_palette.length;ie++){var re=(ie+K)%chosen_palette.length;ne.push([chosen_palette[ie],te[re]])}if("sol"==J||"uni"==J||"ver"==J||"hor"==J)var ae=gene_weighted_choice(ne);else if("wid"==J){var se=Z%chosen_palette.length;ae=chosen_palette[se]}else if("hei"==J)se=(Q+K)%chosen_palette.length,ae=chosen_palette[se];else if("dep"==J)se=K%chosen_palette.length,ae=chosen_palette[se];var ce,le=perlin3D(Z*b+N,Q*M*B+G,K*x+Y);"fuzzy"==noise_cull_rule?ce=gene():"clean"==noise_cull_rule&&(ce=.5);var de=!(ce<le),pe=new THREE.Vector3(Z*(_+y)+k,Q*(g+v)+R,K*(_+y)+C+ee),he=new THREE.Vector3(Z,Q,K),me=he.x.toString()+" "+he.y.toString()+" "+he.z.toString();if(1==de){var _e=elements_per_palette_object[ae];elements_per_palette_object[ae]+=1}else ae=void 0,_e=void 0;var ge={exists:de,position:pe,dist_to_ctr:null,exp_vectors:null,str_perturbance:null,rotation_gene:null,grid_pos:he,color:ae,smooth:oe,base_matrix:null,imesh_idx:_e};dense_matter_object[me]=ge}for(const[e,t]of Object.entries(elements_per_palette_object)){var we=new THREE.Color(e),ue=new THREE.CylinderGeometry(a[m][0],a[m][1],a[m][2],a[m][3],a[m][4],!1),fe=new THREE.MeshPhongMaterial({flatShading:!0}),ve=["attribute vec3 instanceColor;","varying vec3 vInstanceColor;","#include <common>"].join("\n"),ye=["#include <begin_vertex>","\tvInstanceColor = instanceColor;"].join("\n"),Ee=["varying vec3 vInstanceColor;","#include <common>"].join("\n"),be=["vec4 diffuseColor = vec4( diffuse * vInstanceColor, opacity );"].join("\n");fe.onBeforeCompile=function(e){e.vertexShader=e.vertexShader.replace("#include <common>",ve).replace("#include <begin_vertex>",ye),e.fragmentShader=e.fragmentShader.replace("#include <common>",Ee).replace("vec4 diffuseColor = vec4( diffuse, opacity );",be)};var Me=new THREE.InstancedMesh(ue,fe,t),xe=[];for(Z=0;Z<Me.count;Z++)xe.push(we.r),xe.push(we.g),xe.push(we.b);var He=new Float32Array(xe.length);He.set(xe),ue.setAttribute("instanceColor",new THREE.InstancedBufferAttribute(new Float32Array(xe),3)),ue.setAttribute("instanceColorBase",new THREE.BufferAttribute(new Float32Array(He),3)),imeshes_object[e]=Me,I+=t}console.log("%c QUANTITY ","color: white; background: #000000;","\n","Existing elements -> "+I,"\n","Density -> "+Math.round(100*I/P).toString()+"%","\n");var Te=new THREE.Vector3(0,0,1),ke=new THREE.Vector3(1,0,0),Re=new THREE.Vector3(0,0,1);for(const[e,t]of Object.entries(dense_matter_object))if(0!=t.exists){var Ce=new THREE.Object3D;(Me=imeshes_object[t.color]).instanceMatrix.setUsage(THREE.DynamicDrawUsage),Me.frustumCulled=!1;pe=t.position;if(Ce.scale.set(_,g,_),Ce.quaternion.setFromUnitVectors(Te,Re.clone().normalize()),Ce.position.set(pe.x,pe.y,pe.z),0==t.smooth)var Ie=[.5*h,.15*h];else Ie=[0,0];Ce.rotateY(.28*Math.PI+(gene()-.5)*Ie[0]),Ce.rotateOnWorldAxis(ke,(gene()-.5)*Ie[1]),Ce.updateMatrix(),t.base_matrix=Ce.matrix,Me.setMatrixAt(imesh_index_tracker[t.color],Ce.matrix),imesh_index_tracker[t.color]+=1}View.prototype.DenseMatterCreateExplosionVectors(explosion_center_a);var Pe=[];for(const[e,t]of Object.entries(imeshes_object))t.rotateX(global_rot_x),t.rotateY(global_rot_y),t.instanceMatrix.needsUpdate=!0,t.castShadow=!0,t.receiveShadow=!0,t.name=e,this.scene.add(t),Pe.push(t);var Se=[];for(Z=0;Z<chosen_palette.length;Z++){var We=new THREE.Color(chosen_palette[Z]);Se.push(We)}var je=shiftArrayCopy(Se),Ae=0;const De=_*w;if(null==palette_state_t)setInterval((function(){if(color_animation){if(Ae<=flickerDuration){var e=0;for(const[n,i]of Object.entries(imeshes_object)){var t;for(let n=0;n<i.count;n++){let i=new THREE.Matrix4;Pe[e].getMatrixAt(n,i);var o=i.elements[12]/De;t=1-1.1*sigmoid(o+.5-Ae/cycleDuration*3*1.4+.2,.05)>gene()?je[e]:Se[e],Pe[e].geometry.attributes.instanceColor.setXYZ(n,t.r,t.g,t.b)}Pe[e].geometry.attributes.instanceColor.needsUpdate=!0,e++}}(Ae+=flickerInterval)>=cycleDuration&&(Se=[...je],je=shiftArrayCopy(Se),Ae=0)}}),flickerInterval);else for(let e=0;e<palette_state_t%je.length;e++){Se=[...je],je=shiftArrayCopy(Se);K=0;for(const[e,t]of Object.entries(imeshes_object)){var Ve;for(let e=0;e<t.count;e++){let t=new THREE.Matrix4;Pe[K].getMatrixAt(e,t),Ve=Se[K],Pe[K].geometry.attributes.instanceColor.setXYZ(e,Ve.r,Ve.g,Ve.b)}Pe[K].geometry.attributes.instanceColor.needsUpdate=!0,K++}}},View.prototype.DenseMatterCreateExplosionVectors=function(e){for(const[n,i]of Object.entries(dense_matter_object))if(0!=i.exists){var t=i.position;i.rotation_gene={x:gene(),y:gene(),z:gene()},i.dist_to_ctr=t.distanceTo(e),i.str_perturbance=gene_range(.95,1);var o=(new THREE.Vector3).subVectors(t,e).normalize();i.exp_vector=o}},View.prototype.DenseMatterUpdateT=function(e){dense_matter_memory[e]={};var t=Math.sqrt(e);for(const[s,c]of Object.entries(dense_matter_object))if(0!=c.exists){var o=new THREE.Object3D,n=c.exp_vector,i=c.dist_to_ctr;o.applyMatrix4(c.base_matrix);var r=c.str_perturbance,a=explosion_rot_factor/i;o.translateOnAxis(n,r*t*explosion_strength/Math.pow(i,2)),o.rotateX(t*explosion_strength*a*(c.rotation_gene.x*explosion_rot_range*2-explosion_rot_range)/Math.pow(i,3)),o.rotateY(t*explosion_strength*a*(c.rotation_gene.y*explosion_rot_range*2-explosion_rot_range)/Math.pow(i,3)),o.rotateZ(t*explosion_strength*a*(c.rotation_gene.z*explosion_rot_range*2-explosion_rot_range)/Math.pow(i,3)),o.updateMatrix(),dense_matter_memory[e][s]=o.matrix}},View.prototype.DenseMatterUpdateFromMemory=function(e){for(const[n,i]of Object.entries(dense_matter_object))if(0!=i.exists){var t=i.imesh_idx,o=imeshes_object[i.color];null==dense_matter_memory[e]&&console.log(dense_matter_memory,e),o.setMatrixAt(t,dense_matter_memory[e][n])}for(const[e,t]of Object.entries(imeshes_object))t.instanceMatrix.needsUpdate=!0},View.prototype.addStarsRandom=function(e,t){if("left"==triptych)var o=gene_t_l;else if("right"==triptych)o=gene_t_r;else o=gene;const n=new THREE.PolyhedronGeometry([0,1,0,1,0,0,-1,0,0],[2,1,0],.3,0);n.scale(1,1.5,1);const i=new THREE.MeshPhongMaterial({color:16777215}),r=new THREE.InstancedMesh(n,i,t);r.instanceMatrix.setUsage(THREE.DynamicDrawUsage);for(var a=0;a<t;a++){const t=new THREE.Object3D;var s=.5+o();t.scale.set(s,s,s),t.position.set(o()*e-e/2,o()*e-e/2,-2e3),t.rotateX(o()*Math.PI/3-Math.PI/6),t.rotateY(o()*Math.PI/3-Math.PI/6),t.rotateZ(o()*Math.PI/3-Math.PI/6),t.updateMatrix(),r.setMatrixAt(a,t.matrix)}r.instanceMatrix.needsUpdate=!0,this.scene.add(r)},View.prototype.addStarDust=function(){for(var e=5,t=100,o=[],n=0;n<20;n++){var i=new THREE.Vector3(gene_range(-100,t),gene_range(-100,t),-2e3);o.push(i.clone()),e*=.95;for(var r=n%2*.5/Math.sqrt(n+1),a=-(n+1)%2*.5/Math.sqrt(n+1),s=0;s<4e3;s++){var c=new THREE.Vector3(gene_range(-e,e),gene_range(-e+r,e+a),0),l=i.clone();l.add(c),o.push(l),i=l.clone()}}const d=new THREE.PolyhedronGeometry([0,1,0,1,0,0,-1,0,0],[2,1,0],.3,0);d.scale(1,1.5,1);const p=new THREE.MeshPhongMaterial({color:16777215}),h=new THREE.InstancedMesh(d,p,8e4);h.instanceMatrix.setUsage(THREE.DynamicDrawUsage);for(s=0;s<o.length;s++){const e=new THREE.Object3D;var m=0+gene();e.scale.set(m,m,m),e.position.set(o[s].x,o[s].y,-2e3),e.rotateX(gene()*Math.PI/3-Math.PI/6),e.rotateY(gene()*Math.PI/3-Math.PI/6),e.rotateZ(gene()*Math.PI/3-Math.PI/6),e.updateMatrix(),h.setMatrixAt(s,e.matrix)}h.instanceMatrix.needsUpdate=!0,this.scene.add(h)},View.prototype.addMoon=function(){var e,t,o,n,i,r,a,s,c,l=loading_start_time,d=loading_start_time%864e5/864e5;e=gene_range(5,50),t=gene_range(-100,100),o=gene_range(-100,100),i=gene_range(-Math.PI,Math.PI)+2*Math.PI*d,n=gene_range(-Math.PI/2,Math.PI/2),(r=(i+2*Math.PI)*(180/Math.PI)%360)>=0&&r<15?(a="🌗 Third Quarter",s=15-r,c="🌘"):r>=15&&r<75?(a="🌘 Waning Crescent",s=75-r,c="🌑"):r>=75&&r<105?(a="🌑 New Moon",s=105-r,c="🌒"):r>=105&&r<165?(a="🌒 Waxing Crescent",s=165-r,c="🌓"):r>=165&&r<195?(a="🌓 First Quarter",s=195-r,c="🌔"):r>=195&&r<255?(a="🌔 Waxing Gibbous",s=255-r,c="🌕"):r>=255&&r<285?(a="🌕 Full Moon",s=285-r,c="🌖"):r>=285&&r<345?(a="🌖 Waning Gibbous",s=345-r,c="🌗"):r>=345&&r<360&&(a="🌗 Third Quarter",s=375-r,c="🌘"),console.log("%c MOON ","color: white; background: #000000;","\n","Phase -> "+a,"\n","Time to "+c+" -> "+Math.floor(4*s)+" min","\n");const p=new THREE.SphereGeometry(e,64,32,0,2*Math.PI,0,Math.PI/2),h=new THREE.MeshBasicMaterial({color:"#ccc5b6"}),m=new THREE.Mesh(p,h);m.position.set(t,o,-1900),m.rotation.z+=Math.PI/2+n,m.rotateX(-i);const _=new THREE.SphereGeometry(e,64,32,0,2*Math.PI,0,Math.PI/2),g=new THREE.MeshBasicMaterial({color:"#010102"}),w=new THREE.Mesh(_,g);w.position.set(t,o,-1900),w.rotation.z-=Math.PI/2-n,w.rotateX(i),setInterval((function(){const e=Date.now(),t=e-l;l=e,m.rotateX(-2*Math.PI*t/864e5),w.rotateX(2*Math.PI*t/864e5)}),cycleBackgroundUpdate),this.scene.add(m),this.scene.add(w)},View.prototype.calculateFrames=function(){for(let e=0;e<2;e+=.1)e<2&&(e=Math.round(e*Math.pow(10,10))/Math.pow(10,10),View.prototype.DenseMatterUpdateT(e))},View.prototype.preRender=function(){dense_matter_memory={},View.prototype.calculateFrames()},View.prototype.render=function(){if(animation_frametime=Math.round(animation_frametime*Math.pow(10,10))/Math.pow(10,10),null!=explosion_state_t&&(animation_frametime=explosion_state_t),animation_frametime<2&&View.prototype.DenseMatterUpdateFromMemory(animation_frametime),debug)var e=(new Date).getTime();if(this.composer.render(),requestAnimationFrame(this.render.bind(this)),animation_initiated&&(animation_direction?animation_frametime<2&&(animation_frametime+=.1):animation_frametime>0&&(animation_frametime-=.1)),debug){var t=(new Date).getTime();composer_pass=t-e}snap&&(capture(controller),snap=!1),recording&null!=capturer&&capturer.capture(renderer.domElement)};const handler=e=>{tectonica()},capture=e=>{document.documentElement.scrollWidth=viewportWidth*quality,document.documentElement.scrollHeight=viewportHeight*quality,cam_factor_mod=cam_factor*Math.min(viewportWidth*quality/1e3,viewportHeight*quality/1e3),document.getElementById("viewport").style.marginTop="0px",document.getElementById("viewport").style.marginLeft="0px",fitCameraToViewport(e.view,viewportWidth*quality,viewportHeight*quality,!0),composer.render();try{const e=renderer.domElement.toDataURL("img/png"),t=document.createElement("a");t.href=e,t.download=`tectonica_${palette_name}_${parseInt(1e7*Math.random())}.png`,t.click(),URL.revokeObjectURL(e)}catch(e){return void console.log("Browser does not support taking screenshot of 3d context")}quality=1,viewportAdjust(document.getElementById("viewport")),cam_factor_mod=cam_factor*Math.min(viewportWidth*quality/1e3,viewportHeight*quality/1e3),fitCameraToViewport(e.view,viewportWidth,viewportHeight),composer.render()};document.addEventListener("keyup",doc_keyUp,!1),document.addEventListener("DOMContentLoaded",(()=>{tectonica()}));